<?php

include(dirname(__FILE__) . '/includes/class.db.inc.php');
include(dirname(__FILE__) . '/includes/dbstatus.php');

$params = getopt("", array(
	'id:',
	'fecha1:',
	'fecha2:',
	'cias:',
	'no_cargar'
));

$condiciones = array();

if ($params)
{
	if (isset($params['id']))
	{
		$condiciones[] = "f.id = {$params['id']}";
	}

	if (isset($params['fecha1']) || isset($params['fecha2']))
	{
		$condiciones[] = "f.tscan::DATE BETWEEN '{$params['fecha1']}' AND '{$params['fecha2']}'";
	}

	if (isset($params['cias']) && trim($params['cias']) != '')
	{
		$cias = array();

		$pieces = explode(',', $params['cias']);
		foreach ($pieces as $piece)
		{
			if (count($exp = explode('-', $piece)) > 1)
			{
				$cias[] =  implode(', ', range($exp[0], $exp[1]));
			}
			else {
				$cias[] = $piece;
			}
		}

		if (count($cias) > 0)
		{
			$condiciones[] = 'f.num_cia IN (' . implode(', ', $cias) . ')';
		}
	}
}
else if (isset($_REQUEST))
{
	if (isset($_REQUEST['id']))
	{
		$condiciones[] = "f.id = {$_REQUEST['id']}";
	}

	if (isset($_REQUEST['fecha1']) || isset($_REQUEST['fecha2']))
	{
		$condiciones[] = "f.tscan::DATE BETWEEN '{$_REQUEST['fecha1']}' AND '{$_REQUEST['fecha2']}'";
	}

	if (isset($_REQUEST['cias']) && trim($_REQUEST['cias']) != '')
	{
		$cias = array();

		$pieces = explode(',', $_REQUEST['cias']);
		foreach ($pieces as $piece)
		{
			if (count($exp = explode('-', $piece)) > 1)
			{
				$cias[] =  implode(', ', range($exp[0], $exp[1]));
			}
			else {
				$cias[] = $piece;
			}
		}

		if (count($cias) > 0)
		{
			$condiciones[] = 'f.num_cia IN (' . implode(', ', $cias) . ')';
		}
	}
}
else
{
	echo "No hay parametros de busqueda.\n\n";
	die;
}

$db = new DBclass($dsn, 'autocommit=yes');

// $result = $db->query("SELECT COALESCE(COUNT(id), 0) AS num_rows FROM facturas_electronicas f WHERE " . implode(' AND ', $condiciones));
$result = $db->query("SELECT COALESCE(COUNT(id), 0) AS num_rows FROM facturas_electronicas f WHERE id IN (779216, 779219, 779221, 779223, 782874, 782875, 782876, 782877, 782878, 782879, 782880, 782881, 782882, 782883, 782884, 782885, 782886, 782887, 782888, 782889, 782892, 782893, 782894, 782895, 782896, 782897, 782898, 782899, 782900, 782901, 782902, 782903, 782904, 782905, 782906, 782907, 782913, 782914, 782915, 782916, 782917, 782918, 782919, 782920, 782921, 782922, 782923, 782924, 782925, 782926, 782927, 782931, 782932, 782933, 782934, 782935, 782936, 782937, 782938, 782939, 782940, 782941, 782942, 782943, 782944, 782945, 783027, 783028, 783029, 783030, 783031, 783032, 783033, 783034, 783035, 783036, 783037, 783038, 783039, 783040, 783041, 783131, 783132, 783133, 783134, 783135, 783136, 783137, 783138, 783139, 783140, 783141, 783142, 783143, 783144, 783145, 783146, 783147, 783148, 783149, 783150, 783151, 783152, 783153, 783154, 783155, 783156, 783157, 783158, 783159, 783160, 783161, 783162, 783163, 783164, 783165, 783166, 783167, 783168, 783169, 783170, 783171, 783172, 783173, 783174, 783175, 783176, 783177, 783178, 783179, 783180, 783181, 783182, 783183, 783184, 783185, 783186, 783187, 783188, 783189, 783190, 783191, 783192, 783193, 783194, 783195, 783196, 783197, 783198, 783199, 783200, 783201, 783202, 783389, 783390, 783391, 783392, 783393, 783394, 783395, 783396, 783397, 783398, 783399, 783400, 783401, 783402, 783403, 783404, 783405, 783406, 783495, 783496, 783497, 783498, 783499, 783500, 783501, 783502, 783503, 783504, 783505, 783506, 783507, 783508, 783509, 783510, 783511, 783512, 784734, 784735, 784736, 784737, 784738, 784739, 784740, 784741, 784742, 784743, 784744, 784745, 784746, 784747, 784748, 784749, 784750, 784751, 784754, 784755, 784756, 784757, 784758, 784759, 784760, 784761, 784762, 784763, 784764, 784765, 784766, 784767, 784768, 784769, 784770, 784771, 784776, 784777, 784778, 784779, 784780, 784781, 784782, 784783, 784784, 784785, 784786, 784787, 784788, 784789, 784790, 784791, 784792, 784793, 784796, 784797, 784798, 784799, 784800, 784801, 784802, 784803, 784804, 784805, 784806, 784807, 784808, 784809, 784810, 784811, 784812, 784813, 784854, 784855, 784856, 784857, 784858, 784859, 784860, 784861, 784862, 784863, 784864, 784865, 784866, 784867, 784868, 784869, 784870, 784871, 784876, 784877, 784878, 784879, 784880, 784881, 784882, 784883, 784884, 784885, 784886, 784887, 784888, 784889, 784890, 784891, 784892, 784893, 784907, 784908, 784909, 784910, 784911, 784912, 784913, 784914, 784915, 784916, 784917, 784918, 784919, 784920, 784921, 784922, 784923, 784924, 784925, 784926, 784928, 784929, 784930, 784931, 784932, 784933, 784934, 784935, 784936, 784937, 784938, 784939, 784940, 784941, 784942, 784943, 784944, 784945, 784946, 784947, 784948, 784949, 784950, 784951, 784952, 784953, 784954, 784955, 784956, 784957, 784958, 784959, 784960, 784961, 784962, 784963, 784964, 784965, 784966, 784967, 784968, 784969, 784970, 784971, 784972, 784973, 784974, 784975, 784976, 784977, 784978, 784979, 784980, 784981, 784982, 784983, 784984, 784985, 784986, 784987, 784990, 784991, 784992, 784993, 784994, 784995, 784996, 784997, 784998, 784999, 785000, 785001, 785002, 785003, 785004, 785005, 785006, 785007, 785015, 785016, 785017, 785018, 785019, 785020, 785021, 785022, 785023, 785024, 785025, 785026, 785027, 785028, 785029, 785030, 785031, 785032, 785033, 785039, 785040, 785041, 785042, 785043, 785044, 785045, 785046, 785047, 785048, 785049, 785050, 785051, 785052, 785053, 785054, 785055, 785056, 785059, 785060, 785061, 785062, 785063, 785064, 785065, 785066, 785067, 785068, 785069, 785070, 785071, 785072, 785073, 785074, 785075, 785076, 785079, 785080, 785081, 785082, 785083, 785084, 785085, 785086, 785087, 785088, 785089, 785090, 785091, 785092, 785093, 785094, 785095, 785096, 785104, 785105, 785106, 785107, 785108, 785109, 785110, 785111, 785112, 785113, 785114, 785115, 785116, 785117, 785118, 785119, 785120, 785121, 785122, 785132, 785133, 785134, 785135, 785136, 785137, 785138, 785139, 785140, 785141, 785142, 785143, 785144, 785145, 785146, 785147, 785148, 785149, 785152, 785153, 785154, 785156, 785157, 785158, 785159, 785160, 785161, 785162, 785163, 785164, 785165, 785166, 785167, 785168, 785169, 785170, 785173, 785174, 785175, 785176, 785177, 785178, 785179, 785180, 785181, 785182, 785183, 785184, 785185, 785186, 785187, 785188, 785189, 785190, 785191, 785192, 785232, 785233, 785234, 785235, 785236, 785237, 785238, 785239, 785240, 785241, 785242, 785243, 785244, 785245, 785246, 785247, 785248, 785249, 785250, 786038, 786040, 786041, 786042, 786043, 786044, 786045, 786046, 786047, 786048, 786049, 786050, 786051, 786052, 786053, 786054, 786055, 786056, 786057, 786058, 786061, 786062, 786063, 786064, 786065, 786066, 786067, 786068, 786069, 786071, 786072, 786073, 786074, 786075, 786076, 786077, 786078, 786079, 786080, 786081, 786095, 786096, 786097, 786098, 786099, 786100, 786101, 786102, 786103, 786104, 786105, 786106, 786107, 786108, 786109, 786110, 786111, 786112, 786113, 786114, 786127, 786128, 786129, 786130, 786131, 786132, 786133, 786134, 786135, 786136, 786137, 786138, 786139, 786140, 786141, 786142, 786143, 786144, 786145, 786146, 786153, 786154, 786155, 786156, 786157, 786158, 786159, 786160, 786161, 786162, 786163, 786164, 786165, 786166, 786167, 786168, 786169, 786170, 786171, 786198, 786199, 786200, 786201, 786202, 786203, 786204, 786205, 786206, 786207, 786208, 786209, 786210, 786211, 786212, 786240, 786241, 786242, 786243, 786244, 786245, 786246, 786247, 786248, 786249, 786250, 786251, 786252, 786253, 786254, 786255, 786256, 786257, 786258, 786259, 786261, 786262, 786263, 786264, 786265, 786266, 786267, 786268, 786269, 786270, 786271, 786272, 786273, 786274, 786275, 786276, 786277, 786278, 786280, 786281, 786284, 786289, 786294, 786299, 786305, 786311, 786316, 786322, 786326, 786332, 786337, 786342, 786347, 786352, 786357, 786362, 786367, 786372, 786378, 786382, 786387, 786392, 786397, 786403, 786408, 786413, 786418, 786423, 786428, 786433, 786437, 786441, 786446, 786450, 786455, 786460, 786464, 786469, 786476, 786479, 786480, 786481, 786486, 786487, 786488, 786489, 786490, 786491, 786492, 786493, 786494, 786495, 786496, 786497, 786498, 786499, 786500, 786501, 786502, 786503, 786504, 786505, 786506, 786508, 786509, 786510, 786511, 786512, 786513, 786514, 786515, 786516, 786517, 786518, 786520, 786521, 786522, 786523, 786524, 786525, 786526, 786527, 786528, 786529, 786530, 786531, 786532, 786533, 786534, 786535, 786536, 786537, 786538, 786539, 786540, 786541, 786542, 786543, 786544, 786545, 786546, 786547, 786548, 786549, 786550, 786551, 786552, 786553, 786554, 786555, 786556, 786557, 786558, 786559, 786560, 786561, 786562, 786563, 786564, 786565, 786566, 786567, 786568, 786569, 786570, 786571, 786572, 786573, 786574, 786575, 786576, 786577, 786578, 786579, 786580, 786581, 786582, 786583, 786584, 786585, 786586, 786588, 786589, 786590, 786591, 786592, 786593, 786594, 786595, 786596, 786597, 786598, 786599, 786600, 786601, 786602, 786603, 786604, 786605, 786606, 786607, 786609, 786610, 786611, 786612, 786613, 786614, 786615, 786616, 786617, 786618, 786620, 786621, 786622, 786623, 786624, 786625, 786626, 786627, 786628, 786629, 786630, 786633, 786634, 786636, 786637, 786638, 786639, 786641, 786642, 786643, 786644, 786645, 786646, 786647, 786648, 786649, 786650, 786651, 786652, 786653, 786654, 786656, 786657, 786658, 786659, 786660, 786661, 786662, 786663, 786664, 786665, 786666, 786667, 786668, 786669, 786670, 786671, 786672, 786673, 786674, 786675, 786677, 786678, 786679, 786680, 786681, 786682, 786683, 786684, 786685, 786686, 786687, 786688, 786689, 786690, 786692, 786693, 786694, 786695, 786696, 786697, 786704, 786705, 786706, 786707, 786708, 786709, 786710, 786711, 786712, 786713, 786714, 786715, 786716, 786717, 786718, 786719, 786720, 786721, 786722, 786723, 786725, 786726, 786727, 786728, 786729, 786730, 786731, 786732, 786733, 786734, 786735, 786736, 786737, 786738, 786739, 786740, 786741, 786742, 786743, 786744, 786747, 786748, 786749, 786750, 786751, 786752, 786753, 786754, 786755, 786756, 786757, 786758, 786759, 786760, 786761, 786762, 786763, 786764, 786765, 786766, 787475, 787476, 787477, 787478, 787479, 787480, 787481, 787482, 787483, 787484, 787485, 787486, 787487, 787488, 787489, 787490, 787491, 787492, 787493, 787494, 787495, 787498, 787499, 787500, 787501, 787502, 787503, 787504, 787505, 787506, 787507, 787508, 787509, 787510, 787511, 787512, 787513, 787514, 787515, 787516, 787517, 787518, 787522, 787523, 787524, 787525, 787526, 787527, 787528, 787529, 787530, 787531, 787532, 787533, 787534, 787535, 787536, 787537, 787538, 787539, 787540, 787542, 787543, 787544, 787546, 787547, 787550, 787556, 787561, 787567, 787572, 787576, 787577, 787578, 787579, 787580, 787581, 787582, 787583, 787585, 787586, 787587, 787588, 787589, 787590, 787591, 787645, 787647, 787648, 787649, 787651, 787652, 787653, 787654, 787655, 787656, 787657, 787658, 787659, 787660, 787661, 787662, 787663, 787664, 787665, 787666, 787668, 787669, 787672, 787673, 787674, 787676, 787677, 787678, 787679, 787680, 787681, 787682, 787683, 787684, 787685, 787687, 787688, 787689, 787690, 787691, 787692, 787693, 787694, 787695, 787697, 787698, 787699, 787700, 787701, 787702, 787703, 787704, 787705, 787706, 787708, 787709, 787710, 787711, 787712, 787713, 787714, 787716)");

if ($result[0]['num_rows'] == 0)
{
	echo "No hay datos.\n\n";
	die;
}

echo "Registros a cancelar: {$result[0]['num_rows']}\n";

$num_rows = $result[0]['num_rows'];

$rows_per_query = 200;

$offset = 0;

$cont = 1;

// while ($result = $db->query("SELECT
// 	f.num_cia,
// 	f.rfc,
// 	f.fecha,
// 	f.hora,
// 	s.serie,
// 	f.consecutivo
// 		AS folio
// FROM
// 	facturas_electronicas f
// 	LEFT JOIN catalogo_companias cc
// 		USING (num_cia)
// 	LEFT JOIN facturas_electronicas_series s
// 		ON (s.num_cia = f.num_cia AND s.tipo_serie = f.tipo_serie AND f.consecutivo BETWEEN s.folio_inicial AND s.folio_final)
// WHERE
// 	f.id IN (SELECT id FROM facturas_electronicas f WHERE " . implode(' AND ', $condiciones) . " ORDER BY num_cia, tipo_serie, consecutivo LIMIT {$rows_per_query} OFFSET {$offset})
// ORDER BY
// 	f.num_cia,
// 	s.serie,
// 	f.consecutivo"))
while ($result = $db->query("SELECT
	f.num_cia,
	f.rfc,
	f.fecha,
	f.hora,
	s.serie,
	f.consecutivo
		AS folio
FROM
	facturas_electronicas f
	LEFT JOIN catalogo_companias cc
		USING (num_cia)
	LEFT JOIN facturas_electronicas_series s
		ON (s.num_cia = f.num_cia AND s.tipo_serie = f.tipo_serie AND f.consecutivo BETWEEN s.folio_inicial AND s.folio_final)
WHERE
	f.id IN (SELECT id FROM facturas_electronicas f WHERE id IN (779216, 779219, 779221, 779223, 782874, 782875, 782876, 782877, 782878, 782879, 782880, 782881, 782882, 782883, 782884, 782885, 782886, 782887, 782888, 782889, 782892, 782893, 782894, 782895, 782896, 782897, 782898, 782899, 782900, 782901, 782902, 782903, 782904, 782905, 782906, 782907, 782913, 782914, 782915, 782916, 782917, 782918, 782919, 782920, 782921, 782922, 782923, 782924, 782925, 782926, 782927, 782931, 782932, 782933, 782934, 782935, 782936, 782937, 782938, 782939, 782940, 782941, 782942, 782943, 782944, 782945, 783027, 783028, 783029, 783030, 783031, 783032, 783033, 783034, 783035, 783036, 783037, 783038, 783039, 783040, 783041, 783131, 783132, 783133, 783134, 783135, 783136, 783137, 783138, 783139, 783140, 783141, 783142, 783143, 783144, 783145, 783146, 783147, 783148, 783149, 783150, 783151, 783152, 783153, 783154, 783155, 783156, 783157, 783158, 783159, 783160, 783161, 783162, 783163, 783164, 783165, 783166, 783167, 783168, 783169, 783170, 783171, 783172, 783173, 783174, 783175, 783176, 783177, 783178, 783179, 783180, 783181, 783182, 783183, 783184, 783185, 783186, 783187, 783188, 783189, 783190, 783191, 783192, 783193, 783194, 783195, 783196, 783197, 783198, 783199, 783200, 783201, 783202, 783389, 783390, 783391, 783392, 783393, 783394, 783395, 783396, 783397, 783398, 783399, 783400, 783401, 783402, 783403, 783404, 783405, 783406, 783495, 783496, 783497, 783498, 783499, 783500, 783501, 783502, 783503, 783504, 783505, 783506, 783507, 783508, 783509, 783510, 783511, 783512, 784734, 784735, 784736, 784737, 784738, 784739, 784740, 784741, 784742, 784743, 784744, 784745, 784746, 784747, 784748, 784749, 784750, 784751, 784754, 784755, 784756, 784757, 784758, 784759, 784760, 784761, 784762, 784763, 784764, 784765, 784766, 784767, 784768, 784769, 784770, 784771, 784776, 784777, 784778, 784779, 784780, 784781, 784782, 784783, 784784, 784785, 784786, 784787, 784788, 784789, 784790, 784791, 784792, 784793, 784796, 784797, 784798, 784799, 784800, 784801, 784802, 784803, 784804, 784805, 784806, 784807, 784808, 784809, 784810, 784811, 784812, 784813, 784854, 784855, 784856, 784857, 784858, 784859, 784860, 784861, 784862, 784863, 784864, 784865, 784866, 784867, 784868, 784869, 784870, 784871, 784876, 784877, 784878, 784879, 784880, 784881, 784882, 784883, 784884, 784885, 784886, 784887, 784888, 784889, 784890, 784891, 784892, 784893, 784907, 784908, 784909, 784910, 784911, 784912, 784913, 784914, 784915, 784916, 784917, 784918, 784919, 784920, 784921, 784922, 784923, 784924, 784925, 784926, 784928, 784929, 784930, 784931, 784932, 784933, 784934, 784935, 784936, 784937, 784938, 784939, 784940, 784941, 784942, 784943, 784944, 784945, 784946, 784947, 784948, 784949, 784950, 784951, 784952, 784953, 784954, 784955, 784956, 784957, 784958, 784959, 784960, 784961, 784962, 784963, 784964, 784965, 784966, 784967, 784968, 784969, 784970, 784971, 784972, 784973, 784974, 784975, 784976, 784977, 784978, 784979, 784980, 784981, 784982, 784983, 784984, 784985, 784986, 784987, 784990, 784991, 784992, 784993, 784994, 784995, 784996, 784997, 784998, 784999, 785000, 785001, 785002, 785003, 785004, 785005, 785006, 785007, 785015, 785016, 785017, 785018, 785019, 785020, 785021, 785022, 785023, 785024, 785025, 785026, 785027, 785028, 785029, 785030, 785031, 785032, 785033, 785039, 785040, 785041, 785042, 785043, 785044, 785045, 785046, 785047, 785048, 785049, 785050, 785051, 785052, 785053, 785054, 785055, 785056, 785059, 785060, 785061, 785062, 785063, 785064, 785065, 785066, 785067, 785068, 785069, 785070, 785071, 785072, 785073, 785074, 785075, 785076, 785079, 785080, 785081, 785082, 785083, 785084, 785085, 785086, 785087, 785088, 785089, 785090, 785091, 785092, 785093, 785094, 785095, 785096, 785104, 785105, 785106, 785107, 785108, 785109, 785110, 785111, 785112, 785113, 785114, 785115, 785116, 785117, 785118, 785119, 785120, 785121, 785122, 785132, 785133, 785134, 785135, 785136, 785137, 785138, 785139, 785140, 785141, 785142, 785143, 785144, 785145, 785146, 785147, 785148, 785149, 785152, 785153, 785154, 785156, 785157, 785158, 785159, 785160, 785161, 785162, 785163, 785164, 785165, 785166, 785167, 785168, 785169, 785170, 785173, 785174, 785175, 785176, 785177, 785178, 785179, 785180, 785181, 785182, 785183, 785184, 785185, 785186, 785187, 785188, 785189, 785190, 785191, 785192, 785232, 785233, 785234, 785235, 785236, 785237, 785238, 785239, 785240, 785241, 785242, 785243, 785244, 785245, 785246, 785247, 785248, 785249, 785250, 786038, 786040, 786041, 786042, 786043, 786044, 786045, 786046, 786047, 786048, 786049, 786050, 786051, 786052, 786053, 786054, 786055, 786056, 786057, 786058, 786061, 786062, 786063, 786064, 786065, 786066, 786067, 786068, 786069, 786071, 786072, 786073, 786074, 786075, 786076, 786077, 786078, 786079, 786080, 786081, 786095, 786096, 786097, 786098, 786099, 786100, 786101, 786102, 786103, 786104, 786105, 786106, 786107, 786108, 786109, 786110, 786111, 786112, 786113, 786114, 786127, 786128, 786129, 786130, 786131, 786132, 786133, 786134, 786135, 786136, 786137, 786138, 786139, 786140, 786141, 786142, 786143, 786144, 786145, 786146, 786153, 786154, 786155, 786156, 786157, 786158, 786159, 786160, 786161, 786162, 786163, 786164, 786165, 786166, 786167, 786168, 786169, 786170, 786171, 786198, 786199, 786200, 786201, 786202, 786203, 786204, 786205, 786206, 786207, 786208, 786209, 786210, 786211, 786212, 786240, 786241, 786242, 786243, 786244, 786245, 786246, 786247, 786248, 786249, 786250, 786251, 786252, 786253, 786254, 786255, 786256, 786257, 786258, 786259, 786261, 786262, 786263, 786264, 786265, 786266, 786267, 786268, 786269, 786270, 786271, 786272, 786273, 786274, 786275, 786276, 786277, 786278, 786280, 786281, 786284, 786289, 786294, 786299, 786305, 786311, 786316, 786322, 786326, 786332, 786337, 786342, 786347, 786352, 786357, 786362, 786367, 786372, 786378, 786382, 786387, 786392, 786397, 786403, 786408, 786413, 786418, 786423, 786428, 786433, 786437, 786441, 786446, 786450, 786455, 786460, 786464, 786469, 786476, 786479, 786480, 786481, 786486, 786487, 786488, 786489, 786490, 786491, 786492, 786493, 786494, 786495, 786496, 786497, 786498, 786499, 786500, 786501, 786502, 786503, 786504, 786505, 786506, 786508, 786509, 786510, 786511, 786512, 786513, 786514, 786515, 786516, 786517, 786518, 786520, 786521, 786522, 786523, 786524, 786525, 786526, 786527, 786528, 786529, 786530, 786531, 786532, 786533, 786534, 786535, 786536, 786537, 786538, 786539, 786540, 786541, 786542, 786543, 786544, 786545, 786546, 786547, 786548, 786549, 786550, 786551, 786552, 786553, 786554, 786555, 786556, 786557, 786558, 786559, 786560, 786561, 786562, 786563, 786564, 786565, 786566, 786567, 786568, 786569, 786570, 786571, 786572, 786573, 786574, 786575, 786576, 786577, 786578, 786579, 786580, 786581, 786582, 786583, 786584, 786585, 786586, 786588, 786589, 786590, 786591, 786592, 786593, 786594, 786595, 786596, 786597, 786598, 786599, 786600, 786601, 786602, 786603, 786604, 786605, 786606, 786607, 786609, 786610, 786611, 786612, 786613, 786614, 786615, 786616, 786617, 786618, 786620, 786621, 786622, 786623, 786624, 786625, 786626, 786627, 786628, 786629, 786630, 786633, 786634, 786636, 786637, 786638, 786639, 786641, 786642, 786643, 786644, 786645, 786646, 786647, 786648, 786649, 786650, 786651, 786652, 786653, 786654, 786656, 786657, 786658, 786659, 786660, 786661, 786662, 786663, 786664, 786665, 786666, 786667, 786668, 786669, 786670, 786671, 786672, 786673, 786674, 786675, 786677, 786678, 786679, 786680, 786681, 786682, 786683, 786684, 786685, 786686, 786687, 786688, 786689, 786690, 786692, 786693, 786694, 786695, 786696, 786697, 786704, 786705, 786706, 786707, 786708, 786709, 786710, 786711, 786712, 786713, 786714, 786715, 786716, 786717, 786718, 786719, 786720, 786721, 786722, 786723, 786725, 786726, 786727, 786728, 786729, 786730, 786731, 786732, 786733, 786734, 786735, 786736, 786737, 786738, 786739, 786740, 786741, 786742, 786743, 786744, 786747, 786748, 786749, 786750, 786751, 786752, 786753, 786754, 786755, 786756, 786757, 786758, 786759, 786760, 786761, 786762, 786763, 786764, 786765, 786766, 787475, 787476, 787477, 787478, 787479, 787480, 787481, 787482, 787483, 787484, 787485, 787486, 787487, 787488, 787489, 787490, 787491, 787492, 787493, 787494, 787495, 787498, 787499, 787500, 787501, 787502, 787503, 787504, 787505, 787506, 787507, 787508, 787509, 787510, 787511, 787512, 787513, 787514, 787515, 787516, 787517, 787518, 787522, 787523, 787524, 787525, 787526, 787527, 787528, 787529, 787530, 787531, 787532, 787533, 787534, 787535, 787536, 787537, 787538, 787539, 787540, 787542, 787543, 787544, 787546, 787547, 787550, 787556, 787561, 787567, 787572, 787576, 787577, 787578, 787579, 787580, 787581, 787582, 787583, 787585, 787586, 787587, 787588, 787589, 787590, 787591, 787645, 787647, 787648, 787649, 787651, 787652, 787653, 787654, 787655, 787656, 787657, 787658, 787659, 787660, 787661, 787662, 787663, 787664, 787665, 787666, 787668, 787669, 787672, 787673, 787674, 787676, 787677, 787678, 787679, 787680, 787681, 787682, 787683, 787684, 787685, 787687, 787688, 787689, 787690, 787691, 787692, 787693, 787694, 787695, 787697, 787698, 787699, 787700, 787701, 787702, 787703, 787704, 787705, 787706, 787708, 787709, 787710, 787711, 787712, 787713, 787714, 787716) ORDER BY num_cia, tipo_serie, consecutivo LIMIT {$rows_per_query} OFFSET {$offset})
ORDER BY
	f.num_cia,
	s.serie,
	f.consecutivo"))
{
	$num_cia = NULL;
	$serie = NULL;
	$folio = NULL;

	foreach ($result as $i => $df)
	{
		$datos = array(
			'num_cia'	=> $df['num_cia'],
			'rfc'		=> $df['rfc'],
			'serie'		=> $df['serie'],
			'folio'		=> $df['folio']
		);

		$xml_carga = generar_xml_datos($datos, isset($_REQUEST['no_cargar']) || isset($params['no_cargar']) ? TRUE : FALSE);

		if ( ! isset($_REQUEST['no_cargar']) && ! isset($params['no_cargar']))
		{
			$response = consumir_webservice($xml_carga);

			$ob_data = json_decode(utf8_encode($response));

			if ($response === FALSE)
			{
				$status = "Webservice no disponible.";
			}

			// Decodificar respuesta
			$ob_data = json_decode(utf8_encode($response));

			if ($ob_data->status < 0)
			{
				$status = utf8_encode(isset($ob_data->error) ? $ob_data->error : (isset($ob_data->complete_msg) ? $ob_data->complete_msg : (isset($ob_data->import_msg) ? $ob_data->import_msg : print_r($response, TRUE))));
			}
			else
			{
				$status = "Cancelacion de documento exitosa.";
			}
		}
		else
		{
			$status = "No se cargo documento a OpenBravo.";
		}

		echo "\n[#{$cont}] Documento CIA: {$df['num_cia']} SERIE: {$df['serie']} FACT: {$df['folio']} RESPUESTA: {$status}";
		// echo "<br />{$xml_carga}";

		$cont++;
	}

	$offset += $rows_per_query;
}

function generar_xml_datos($datos, $no_cargar = FALSE)
{
	// Crear documento XML con los datos para el webservice
	$xml = new DOMDocument('1.0', 'UTF-8');

	$xml->xmlStandalone = TRUE;
	$xml->formatOutput = TRUE;

	// Construir estructura del XML
	$xml_timbreCancel = $xml->createElement('timbreCancel');
	$xml->appendChild($xml_timbreCancel);

	$xml_rfc = $xml->createElement('rfc', htmlspecialchars(utf8_encode($datos['rfc'])));
	$xml_timbreCancel->appendChild($xml_rfc);

	$xml_invoices = $xml->createElement('invoices');
	$xml_timbreCancel->appendChild($xml_invoices);

	$xml_invoice = $xml->createElement('invoice');
	$xml_invoices->appendChild($xml_invoice);

	$xml_documentno = $xml->createElement('documentno', htmlspecialchars(utf8_encode($datos['serie'] . $datos['folio'])));
	$xml_invoice->appendChild($xml_documentno);

	$xml_org = $xml->createElement('org', $datos['num_cia']);
	$xml_invoice->appendChild($xml_org);

	// Guardar XML de carga
	if ($no_cargar)
	{
		$xml->save(dirname(__FILE__) . "/tmp/carga-cancelacion-{$datos['num_cia']}-{$datos['serie']}{$datos['folio']}.xml");
	}

	// Retornar el XML
	return $xml->saveXML();
}

function consumir_webservice($xml_data)
{
	// Construir arreglo de opciones para consumir el webservice
	$stream_options = array(
		'http' => array(
			'method'	=> 'PUT',
			'header'	=> 'Authorization: Basic ' . base64_encode("Openbravo:openbravo") . ' Content-Type: text/xml',
			'content'	=> $xml_data,
		),
	);

	// Crear contexto de flujo con las opciones para consumir el webservice
	$context = stream_context_create($stream_options);

	// Consumir webservice y obtener respuesta
	// $ob_response = @file_get_contents('http://192.168.1.251:443/ob_lecaroz/ws/mx.cusoft.importing.rest.insertLecInvoice', NULL, $context);
	$ob_response = @file_get_contents('http://192.168.1.3:443/ob_lecaroz/ws/mx.cusoft.importing.rest.insertLecInvoice', NULL, $context);

	return $ob_response;
}

function dmy_to_ymd($date)
{
	list($day, $month, $year) = explode('/', $date);

	return date('Y-m-d', mktime(0, 0, 0, $month, $day, $year));
}
